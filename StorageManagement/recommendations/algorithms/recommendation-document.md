در این نسخه به‌روز شده از مستندات، بخش‌های مهم‌تر، دقیق‌تر و جامع‌تر توضیح داده شده‌اند تا درک کاملی از منطق و پیاده‌سازی سیستم توصیه‌گر فراهم شود:

---

# 📊 Hybrid Recommendation Algorithm

این مستند، طراحی و منطق سیستم توصیه‌گر هیبریدی در پروژه جنگو را شرح می‌دهد. این سیستم با ترکیب **فیلتر محتوایی (Content-Based Filtering)** و **فیلتر مشارکتی (Collaborative Filtering)**، پیشنهادهایی شخصی‌سازی‌شده برای کاربران تولید می‌کند؛ مبتنی بر ویژگی‌های محصولات و الگوهای خرید کاربران.

---

## 🚀 Overview

الگوریتم توصیه‌گر به‌صورت پویا با توجه به سطح فعالیت کاربر رفتار خود را تطبیق می‌دهد:

* **کاربران جدید** → تاکید بیشتر بر محتوا (content-based)
* **کاربران فعال** → تاکید بیشتر بر تعاملات کاربران (collaborative)
* **کاربران نیمه‌فعال** → ترکیبی متعادل از هر دو روش

---

## 🧠 Core Components

### 1. Content-Based Filtering

سیستم با توجه به ویژگی‌های هر محصول برای کاربر مشابه‌ترین‌ها را پیدا می‌کند:

#### 📌 ویژگی‌های مورد استفاده:

* **Profit Margin**: اختلاف سود از قیمت خرید و فروش
* **Product Average Score**: میانگین امتیاز دریافت‌شده توسط محصول
* **User Rating**: امتیازی که کاربر به محصول داده است
* **Product Categories**: دسته‌بندی‌های محصول (با One-Hot Encoding)

#### ⚙️ پردازش:

* ویژگی‌های عددی با `StandardScaler` نرمال‌سازی می‌شوند
* برای تشابه بین بردار ویژگی‌ها از **Cosine Similarity** استفاده می‌شود

### 2. Collaborative Filtering

با تحلیل رفتار کاربران مشابه، برای هر کاربر محصولاتی پیشنهاد می‌شود که توسط دیگران با رفتار مشابه مورد پسند واقع شده‌اند.

#### 📌 مراحل:

* ساخت **ماتریس کاربر-محصول** (User-Item Matrix) با استفاده از `pandas.pivot_table`
* استفاده از `KNN (NearestNeighbors)` با متریک `cosine` برای یافتن کاربران مشابه
* میانگین‌گیری از امتیازات کاربران مشابه برای محصولات مشترک

---

## ⚙️ Hybrid Strategy

امتیازات حاصل از دو روش فوق، با ضرایب ترکیبی ترکیب می‌شوند:

| نوع کاربر            | α (Content) | β (Collaborative) | توضیح                        |
| -------------------- | ----------- | ----------------- | ---------------------------- |
| کاربر جدید (۰ سفارش) | 0.7         | 0.3               | Cold start – بدون سابقه خرید |
| نیمه‌فعال (<۵ سفارش) | 0.5         | 0.5               | رفتار متوسط                  |
| فعال (≥۵ سفارش)      | 0.3         | 0.7               | وابستگی بیشتر به هم‌سلیقه‌ها |

---

## 🔄 Algorithm Flow

1. **بارگیری داده‌ها** از `order_items_data.csv` (تاریخچه سفارش و امتیازات)
2. **پیش‌پردازش داده‌ها**:

   * پرکردن مقادیر گمشده (rating و دسته‌بندی‌ها)
   * نرمال‌سازی ویژگی‌های عددی
   * کدگذاری دسته‌بندی‌ها به روش One-Hot
3. **ساخت ماتریس‌ها**:

   * بردار ویژگی‌های محتوایی محصولات
   * ماتریس تعامل کاربران و محصولات (user-item)
4. **تولید پیشنهادات اولیه**:

   * از طریق شباهت ویژگی‌های محصول (content)
   * از طریق کاربران مشابه (collaborative)
5. **ترکیب نتایج با ضرایب وزنی**:

   * امتیاز نهایی = α × محتوایی + β × مشارکتی
6. **اعمال محدودیت‌های تجاری**:

   * فقط محصولاتی پیشنهاد می‌شوند که حداقل ۳ عدد موجودی دارند

---

## 📥 Input

* `user_email`: ایمیل منحصربه‌فرد کاربر برای استخراج اطلاعات و شناسه

---

## 📤 Output (API Response)

```json
{
  "success": true,
  "recommendations": [
    {
      "product_name": "Organic Almond Milk",
      "product_image": "https://example.com/image1.jpg",
      "product_avg_score": 4.2,
      "score": 0.78,
      "source": "content"
    },
    {
      "product_name": "Dark Chocolate",
      "product_image": "https://example.com/image2.jpg",
      "product_avg_score": 4.3,
      "score": 0.70,
      "source": "collaborative"
    }
  ],
  "metadata": {
    "user_order_count": 4,
    "alpha": 0.5,
    "beta": 0.5,
    "reason": "few orders"
  }
}
```

---

## 📎 Additional Notes

* در صورتی که اطلاعات کاربر یا محصول ناقص باشد (مانند عدم موجودی یا نبود در پایگاه داده)، از پیشنهاد دادن آن صرف‌نظر می‌شود
* امتیازات در خروجی به صورت **وزنی نهایی** بوده و به صورت گرد شده (تا ۳ رقم اعشار) ارائه می‌شوند
* در صورتی که داده‌ی کافی وجود نداشته باشد، خروجی خالی یا با هشدار برمی‌گردد

---
